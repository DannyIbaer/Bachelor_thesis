---
title: "2.PATHWAY_clusters"
author: "DANIEL BERNAD IBÁÑEZ"
date: "2025-06-18"
output: html_document
---

```{r, include=FALSE, echo=FALSE, results='hide'}
# Function to install and load packages
install_and_load <- function(packages) {
  # Detect Bioconductor packages
  bioc_packages <- c("clusterProfiler", "org.Hs.eg.db", "ReactomePA",
  "dorothea", "enrichplot")
  
  for (pkg in packages) {
    if (!require(pkg, character.only = TRUE)) {
      if (pkg %in% bioc_packages) {
        # Install BiocManager if not available
        if (!requireNamespace("BiocManager", quietly = TRUE)) {
          install.packages("BiocManager")
        }
        BiocManager::install(pkg, update = FALSE, ask = FALSE)
      } else {
        install.packages(pkg, dependencies = TRUE)
      }
      library(pkg, character.only = TRUE)
    }
  }
}

```

```{r, include=FALSE, echo=FALSE, results='hide'}
# List of required packages
required_packages <- c(
  "clusterProfiler", "org.Hs.eg.db", "ReactomePA",
  "dplyr", "readr", "tibble", "dorothea", "openxlsx",
  "tidyverse", "plotly", "clusterProfiler", "org.Hs.eg.db",
  "ggplot2", "BiocManager", "writexl", "enrichplot"
)

# Install and load packages
cat("Installing and loading libraries...\n")
install_and_load(required_packages)
```

res_cluster1_vs_control <- results(dds_gene_cluster, contrast = c("cluster", "1", "control"))

# For cluster 2 vs control
res_cluster2_vs_control <- results(dds_gene_cluster, contrast = c("cluster", "2", "control"))

# For cluster 3 vs control
res_cluster3_vs_control <- results(dds_gene_cluster, contrast = c("cluster", "3", "control"))


##.......................................................cluster VS CONTROL.......................................................
```{r}
# If using the csv data instead of doing all prior processing
res_gene_cluster_annotated <- read.csv("C:/Users/cst325/Desktop/BACHELORS/Rdata/Data/cluster/res_gene_cluster_annotated.csv")
```

```{r}
# Filter genes with adjusted p-value < 0.05
significant_res_cluster_annotated <- res_gene_cluster_annotated[which(res_gene_cluster_annotated$padj < 0.05), ]

# Check how many significant genes you have
nrow(significant_res_cluster_annotated)
```

```{r}
# Split into upregulated (log2FoldChange > 0) and downregulated (log2FoldChange < 0)
up_cluster <- significant_res_cluster_annotated[which(significant_res_cluster_annotated$log2FoldChange > 1), ]
down_cluster <- significant_res_cluster_annotated[which(significant_res_cluster_annotated$log2FoldChange < -1), ]

# Check how many you have in each group
nrow(up_cluster)
nrow(down_cluster)

# Optional: view top few from each
head(up_cluster)
head(down_cluster)
```


## UPREGULATED
```{r}
# Sort table by baseMean in ascending order
up_cluster_sorted <- up_cluster[order(up_cluster$baseMean),]

#Calculate total number of rows (genes)
n <- nrow(up_cluster_sorted)

# Find median
median_pos <- ceiling(n / 2)

# Calculate Q1 position of the median
q1_of_median <- ceiling ((median_pos + 1)/4)

# Filter out low baseMean genes
up_cluster_filtered <- up_cluster_sorted[which(up_cluster_sorted$baseMean >= q1_of_median), ]

# Check how many genes are left
nrow(up_cluster_filtered)

# Optional: preview the filtered table
head(up_cluster_filtered)
```

```{r}
# Convert Ensembl IDs to Entrez IDs
gene.df <- bitr(up_cluster_filtered$GENEID, fromType = "ENSEMBL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)

# Merge with filtered table to retain original data
up_cluster_filtered_annotated <- merge(up_cluster_filtered, gene.df, by.x = "GENEID", by.y = "ENSEMBL")

# Check the first few rows after annotation
head(up_cluster_filtered_annotated)
```

-------------------------------------------- ENRICHMENT - GO--------------------------------------------
```{r}
# Perform GO enrichment analysis 
ego_up_cluster <- enrichGO(gene = up_cluster_filtered_annotated$ENTREZID,
                   OrgDb = org.Hs.eg.db,
                   keyType = "ENTREZID", # We use the entrez IDs mapped earlier as they lead to less issues downstream
                   ont = "ALL", # i.e. Cellular Components, Molecular Mechanisms and Biological Processes 
                   pAdjustMethod = "BH",
                   pvalueCutoff = 0.05,
                   qvalueCutoff = 0.2,
                   readable = TRUE,
                   minGSSize = 10,      # Only include pathways with ≥10 genes
                   maxGSSize = 1000     # Exclude very large, generic pathways
  )

tab_go_up_cluster <- as.data.frame(ego_up_cluster@result)

# View the first few rows of the combined results
head(ego_up_cluster)
```

```{r}
# Write the pathway data to an Excel file
write.xlsx(tab_go_up_cluster, file = "C:/Users/cst325/Desktop/BACHELORS/Rdata/Data/cluster/UP/GO_up_cluster.xlsx", rowNames = TRUE)
```


## Filtering and visualization
```{r}
# Plot the filtered results using dotplot (still an enrichResult object)
dotplot(ego_up_cluster, showCategory = 30)

# Plot the filtered results using barplot (also for the enrichResult object)
barplot(ego_up_cluster, showCategory = 30)
```

## Dotplot
```{r}
# Subset and order the data by RichFactor
plot_data <- ego_up_cluster@result

plot_data <- plot_data[plot_data$p.adjust <= 0.05, ]
plot_data <- plot_data[order(plot_data$RichFactor, decreasing = TRUE), ]
plot_data <- head(plot_data, 30)  # Take top 30 pathways

# Dotplot using ggplot2 
p <- ggplot(plot_data, aes(x = reorder(Description, RichFactor), y = RichFactor, 
                      size = Count, color = pvalue)) +
  geom_point() +
  coord_flip() +  # Flip the coordinates for better readability
  labs(x = "GO Terms", y = "RichFactor", title = "Upregulated GO Term Enrichment for clusterivation") +
  scale_size_continuous(name = "Gene Count") +
  scale_color_gradient(low = "blue", high = "red") +  # Color gradient based on p-value
  scale_shape_manual(values = c(16, 17, 18)) +  # Manually set different shapes for BP, MF, CC
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for better readability

# Save the plot as a PNG file
  ggsave("C:/Users/cst325/Desktop/BACHELORS/Rdata/Plots/UPggGO_cluster_pathways.jpg", plot = p, width = 10, height = 8, dpi = 300)
```

-------------------------------------------- ENRICHMENT - KEGG --------------------------------------------
```{r}
# Perform KEGG enrichment analysis 
ekegg_up_cluster <- enrichKEGG(
  gene          = up_cluster_filtered_annotated$ENTREZID,
  organism      = 'hsa',
  keyType       = "ncbi-geneid",
  pAdjustMethod = "BH",
  pvalueCutoff  = 0.05,
  minGSSize = 10,      # Only include pathways with ≥10 genes
  maxGSSize = 1000     # Exclude very large, generic pathways
)

tab_kegg_up_cluster <- as.data.frame(ekegg_up_cluster)

head(tab_kegg_up_cluster)
```
# Annotation
```{r}
# Load the necessary library for gene ID conversion
library(org.Hs.eg.db)

# Sample data: Let's assume your table is named `up_cluster_filtered_annotated`
# where "geneID" is a column with ENTREZ IDs in the format you mentioned (e.g., "283/20202/20202/")

# Step 1: Split the "geneID" column into individual ENTREZ IDs
tab_kegg_up_cluster$geneID_split <- strsplit(as.character(tab_kegg_up_cluster$geneID), "/")

# Step 2: Define a function to map ENTREZ IDs to gene symbols
map_entrez_to_symbol <- function(entrez_ids) {
  # Remove any empty strings caused by trailing slashes
  entrez_ids <- entrez_ids[entrez_ids != ""]
  # Use mapIds to get gene symbols from ENTREZ IDs
  gene_symbols <- mapIds(org.Hs.eg.db, keys = entrez_ids, column = "SYMBOL", keytype = "ENTREZID", multiVals = "first")
  # Return the gene symbols as a character vector
  return(gene_symbols)
}

# Step 3: Apply the mapping function to each row (the "geneID_split" column)
tab_kegg_up_cluster$GENENAME <- sapply(tab_kegg_up_cluster$geneID_split, map_entrez_to_symbol)

# Step 4: Reassemble the gene symbols into a single string (separated by "/")
tab_kegg_up_cluster$GENENAME <- sapply(tab_kegg_up_cluster$GENENAME, function(x) paste(x, collapse = "/"))

# View the updated table with the combined gene symbols column
head(tab_kegg_up_cluster)

# Step 1: Replace the 'geneID' column with the values from 'GENENAME' column
tab_kegg_up_cluster$geneID <- tab_kegg_up_cluster$GENENAME

# Step 2: Remove the 'GENENAME' column
tab_kegg_up_cluster$GENENAME <- NULL

head(tab_kegg_up_cluster)
```
```{r}
# Write the pathway data to an Excel file
write.xlsx(tab_kegg_up_cluster, file = "C:/Users/cst325/Desktop/BACHELORS/Rdata/Data/cluster/UP/kegg_up_cluster.xlsx", rowNames = TRUE)
```


# Visualization

```{r}
# Plot the filtered results using dotplot (still an enrichResult object)
dotplot(ekegg_up_cluster, showCategory = 30)

# Plot the filtered results using barplot (also for the enrichResult object)
barplot(ekegg_up_cluster, showCategory = 30)
```

# Dotplot
```{r}
# Subset and order the data by RichFactor
plot_data <- ekegg_up_cluster@result

plot_data <- plot_data[plot_data$p.adjust <= 0.05, ]
plot_data <- plot_data[order(plot_data$RichFactor, decreasing = TRUE), ]
plot_data <- head(plot_data, 30)  # Take top 30 pathways

# Create the dot plot using ggplot2
p <- ggplot(plot_data, aes(x = reorder(Description, RichFactor), y = RichFactor, 
                           size = Count, color = pvalue)) +  # Use Count for size
  geom_point() +
  coord_flip() +  # Flip the coordinates for better readability
  labs(x = "KEGG Pathways", y = "RichFactor", title = "Upregulated KEGG Pathway Enrichment for clusterivation ") +
  scale_size_continuous(name = "Gene Count") +
  scale_color_gradient(low = "blue", high = "red") +  # Color gradient based on p-value
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for readability

# Save the plot as a PNG file
ggsave("C:/Users/cst325/Desktop/BACHELORS/Rdata/Plots/UPKEGG_cluster_pathways.jpg", 
       plot = p, width = 10, height = 8, dpi = 300)
```

-------------------------------------------- ENRICHMENT - REAC --------------------------------------------
```{r}
library(ReactomePA)

ereact_up_cluster <- enrichPathway(
  gene = up_cluster_filtered_annotated$ENTREZID,
  organism = "human",
  pAdjustMethod = "BH",
  qvalueCutoff = 0.05,
  readable = TRUE,
  minGSSize = 10,      # Only include pathways with ≥10 genes
  maxGSSize = 1000     # Exclude very large, generic pathways
) 

tab_react_up_cluster <- as.data.frame(ereact_up_cluster@result)

head(ereact_up_cluster)
```

```{r}
# Write the pathway data to an Excel file
write.xlsx(tab_react_up_cluster, file = "C:/Users/cst325/Desktop/BACHELORS/Rdata/Data/cluster/UP/react_up_cluster.xlsx", rowNames = TRUE)
```

# Visualization
```{r}
# Plot the filtered results using dotplot (still an enrichResult object)
dotplot(ereact_up_cluster, showCategory = 30)

# Plot the filtered results using barplot (also for the enrichResult object)
barplot(ereact_up_cluster, showCategory = 30)
```

```{r}
# Subset and order the data by RichFactor
plot_data <- ereact_up_cluster@result
plot_data <- plot_data[order(plot_data$RichFactor, decreasing = TRUE), ]
plot_data <- head(plot_data, 30)  # Take top 30 pathways

# Create the dot plot using ggplot2
p <- ggplot(plot_data, aes(x = reorder(Description, RichFactor), y = RichFactor, 
                           size = Count, color = pvalue)) +  # Use Count for size
  geom_point() +
  coord_flip() +  # Flip the coordinates for better readability
  labs(x = "REAC Pathways", y = "RichFactor", title = "Upregulated REAC Pathway Enrichment for clusterivation ") +
  scale_size_continuous(name = "Gene Count") +
  scale_color_gradient(low = "blue", high = "red") +  # Color gradient based on p-value
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for readability

# Save the plot as a PNG file
ggsave("C:/Users/cst325/Desktop/BACHELORS/Rdata/Plots/UPREAC_cluster_filteredpathways.jpg", 
       plot = p, width = 10, height = 8, dpi = 300)
```

-------------------------------------------- ENRICHMENT - TF --------------------------------------------
```{r}
dorothea_hs <- dorothea::dorothea_hs

dorothea_tf <- dorothea_hs %>%
  dplyr::filter(confidence %in% c("A", "B")) %>%
  dplyr::select(tf, target) %>%
  dplyr::distinct()

etf_up_cluster <- enricher(
  gene = up_cluster_filtered_annotated$GENENAME,
  TERM2GENE = dorothea_tf,
  pAdjustMethod = "BH",
  qvalueCutoff = 0.05,
  minGSSize = 10,      # Only include pathways with ≥10 genes
  maxGSSize = 1000     # Exclude very large, generic pathways
) 

tab_tf_up_cluster <- as.data.frame(etf_up_cluster@result)

head(etf_up_cluster)
```

```{r}
# Write the pathway data to an Excel file
write.xlsx(tab_tf_up_cluster, file = "C:/Users/cst325/Desktop/BACHELORS/Rdata/Data/cluster/UP/TF_up_cluster.xlsx", rowNames = TRUE)
```

# Visualization
```{r}
# Plot the filtered results using dotplot (still an enrichResult object)
dotplot(etf_up_cluster, showCategory = 30)

# Plot the filtered results using barplot (also for the enrichResult object)
barplot(etf_up_cluster, showCategory = 30)
```

```{r}
# Subset and order the data by RichFactor
plot_data <- etf_up_cluster@result

# Filter for significant p-values
plot_data <- plot_data[plot_data$p.adjust <= 0.05, ]
plot_data <- plot_data[order(plot_data$RichFactor, decreasing = TRUE), ]
plot_data <- head(plot_data, 30)  # Take top 30 pathways

# Create the dot plot using ggplot2
p <- ggplot(plot_data, aes(x = reorder(Description, RichFactor), y = RichFactor, 
                           size = Count, color = pvalue)) +  # Use Count for size
  geom_point() +
  coord_flip() +  # Flip the coordinates for better readability
  labs(x = "TF Pathways", y = "RichFactor", title = "Upregulated TF for clusterivation ") +
  scale_size_continuous(name = "Gene Count") +
  scale_color_gradient(low = "blue", high = "red") +  # Color gradient based on p-value
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for readability

# Save the plot as a PNG file
ggsave("C:/Users/cst325/Desktop/BACHELORS/Rdata/Plots/UPTF_cluster_filteredpathways.jpg", 
       plot = p, width = 10, height = 8, dpi = 300)
```

-------------------------------------------- ENRICHMENT - MSigDB --------------------------------------------
```{r}
hallmark_gmt <- read.gmt("C:/Users/cst325/Desktop/BACHELORS/Rdata/Databases/h.all.v2024.1.Hs.symbols.gmt")

# Hallmark ORA
ehallmark_up_cluster <- enricher(
  gene = up_cluster_filtered_annotated$GENENAME,
  TERM2GENE = hallmark_gmt,
  pAdjustMethod = "BH",
  qvalueCutoff = 0.05,
  minGSSize = 10,      # Only include pathways with ≥10 genes
  maxGSSize = 1000     # Exclude very large, generic pathways
)

tab_hallmarks_up_cluster <- as.data.frame(ehallmark_up_cluster@result)

head (ehallmark_up_cluster)
```

```{r}
# Write the pathway data to an Excel file
write.xlsx(tab_hallmarks_up_cluster, file = "C:/Users/cst325/Desktop/BACHELORS/Rdata/Data/cluster/UP/HALLMARKS_up_cluster.xlsx", rowNames = TRUE)
```

# Visualization
```{r}
# Plot the filtered results using dotplot (still an enrichResult object)
dotplot(ehallmark_up_cluster, showCategory = 30)

# Plot the filtered results using barplot (also for the enrichResult object)
barplot(ehallmark_up_cluster, showCategory = 30)
```

```{r}
# Subset and order the data by RichFactor
plot_data <- ehallmark_up_cluster@result

plot_data <- plot_data[plot_data$p.adjust <= 0.05, ]
plot_data <- plot_data[order(plot_data$RichFactor, decreasing = TRUE), ]
plot_data <- head(plot_data, 30)  # Take top 30 pathways

# Create the dot plot using ggplot2
p <- ggplot(plot_data, aes(x = reorder(Description, RichFactor), y = RichFactor, 
                           size = Count, color = pvalue)) +  # Use Count for size
  geom_point() +
  coord_flip() +  # Flip the coordinates for better readability
  labs(x = "Hallmarks", y = "RichFactor", title = "Upregulated Hallmarks for clusterivation ") +
  scale_size_continuous(name = "Gene Count") +
  scale_color_gradient(low = "blue", high = "red") +  # Color gradient based on p-value
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for readability

# Save the plot as a PNG file
ggsave("C:/Users/cst325/Desktop/BACHELORS/Rdata/Plots/UPHallmarks_cluster_filteredpathways.jpg", 
       plot = p, width = 10, height = 8, dpi = 300)
```

-------------------------------------------- ORA results --------------------------------------------
```{r}
# Add the 'Source' column to each existing dataframe and fill with the appropriate value
tab_go_up_cluster$Source <- "GO"
tab_kegg_up_cluster$Source <- "KEGG"
tab_react_up_cluster$Source <- "reactome"
tab_tf_up_cluster$Source <- "TF"
tab_hallmarks_up_cluster$Source <- "MSigDB"

### Combine All Results

# Set thresholds
pval_cutoff <- 0.05
RichFactor_min <- 0.1

# Combine all enrichment results and filter
up_cluster_enrich <- bind_rows(
  tab_go_up_cluster,
  tab_kegg_up_cluster,
  tab_react_up_cluster,
  tab_tf_up_cluster,
  tab_hallmarks_up_cluster,
)

# Apply the updated filter: 
# 1. Keep pathways with RichFactor greater than Q1
# 2. Keep pathways with count >= 5 genes
up_cluster_enrich_filtered <- up_cluster_enrich %>%
  dplyr::filter(
    p.adjust <= pval_cutoff,
    RichFactor >= RichFactor_min,             # Keep pathways with RichFactor > Q1
    Count >= 3                           # Keep pathways with at least 3 genes
  ) %>%
  mutate(
    importance = -log10(p.adjust) * RichFactor # Calculate importance
  ) %>%
  arrange(desc(importance))                  # Sort by importance

# Get top 20 pathways
top_pathways <- up_cluster_enrich_filtered %>% head(20)

### Export
library(writexl)
write_xlsx(up_cluster_enrich_filtered, "C:/Users/cst325/Desktop/BACHELORS/Rdata/Data/up_cluster_enrich_filtered.xlsx")

# Function to convert categorical variables to factors
convert_to_factors <- function(df) {
  # Loop over each column
  for (col in colnames(df)) {
    # Check if the column is a character (categorical) type
    if (is.character(df[[col]])) {
      df[[col]] <- as.factor(df[[col]])  # Convert to fclusteror
    }
  }
  return(df)  # Return the modified dataframe
}

# Apply the function to your dataframe
fact.up_cluster_enrich_filtered <- convert_to_factors(up_cluster_enrich_filtered)

### 9. View top results
head(up_cluster_enrich_filtered)

summary(fact.up_cluster_enrich_filtered)
```

## Pathway to gene table
```{r}
df <- up_cluster_enrich_filtered  #dataframe

# Split geneID by "/" to separate the gene IDs
gene_list <- strsplit(df$geneID, split = "/")

# Get the max number of genes in any pathway to standardize column size
max_genes <- max(sapply(gene_list, length))

# Pad shorter gene lists with NA to match the max number of genes
gene_matrix <- t(sapply(gene_list, function(x) {
  length(x) <- max_genes  # pad with NAs
  return(x)
}))

# Convert to data.frame and name columns
gene_df <- as.data.frame(gene_matrix, stringsAsfactors = FALSE)
colnames(gene_df) <- paste0("Gene_", seq_len(max_genes))

# Combine with pathway ID and Description
pathway_up_cluster <- cbind(Pathway_ID = df$ID, gene_df)
rownames(pathway_up_cluster) <- df$Description

# View the first few rows of the combined table
head(pathway_up_cluster)

# Load library for writing Excel file
library(openxlsx)

# Write the pathway data to an Excel file
write.xlsx(pathway_up_cluster, file = "C:/Users/cst325/Desktop/BACHELORS/Rdata/pathwaytogene_up_cluster.xlsx", rowNames = TRUE)
```

# Gene Matrix

```{r}
# Create a dataframe to store pathway and gene symbols
pathway_gene_symbols <- data.frame(Pathway = character(), GeneSymbols = character(), stringsAsFactors = FALSE)

# Loop through the pathways and extract gene symbols
for (i in 1:nrow(up_cluster_enrich_filtered)) {
  pathway_description <- up_cluster_enrich_filtered$Description[i]  # Pathway description
  
  # Split geneID by "/" to get individual gene symbols
  gene_symbols <- unlist(strsplit(up_cluster_enrich_filtered$geneID[i], "/"))
  
  # Remove any empty or NA gene symbols (just in case)
  gene_symbols <- gene_symbols[!is.na(gene_symbols) & gene_symbols != ""]
  
  # Combine gene symbols into a single string
  gene_symbols_str <- paste(gene_symbols, collapse = ", ")
  
  # Add the pathway description and gene symbols to the dataframe
  pathway_gene_symbols <- rbind(pathway_gene_symbols, data.frame(Pathway = pathway_description, GeneSymbols = gene_symbols_str, stringsAsfactors = FALSE))
}

# Check the final table of pathways and gene symbols
print(pathway_gene_symbols)

# Step 2: Prepare the data for creating the gene matrix

# Create a vector of all unique gene symbols across the pathways
unique_genes <- unique(unlist(strsplit(paste(pathway_gene_symbols$GeneSymbols, collapse = ","), ", ")))

# Initialize the gene matrix: pathways as rows, gene symbols as columns
gene_matrix <- matrix(0, nrow = length(pathway_gene_symbols$Pathway), ncol = length(unique_genes))

# Assign row and column names to the matrix
rownames(gene_matrix) <- pathway_gene_symbols$Pathway
colnames(gene_matrix) <- unique_genes

# Step 3: Fill the matrix: if a gene is associated with a pathway, set the corresponding entry to 1
for (i in 1:nrow(gene_matrix)) {
  # Get the genes for the current pathway
  genes <- unlist(strsplit(pathway_gene_symbols$GeneSymbols[i], ", "))  # Split gene symbols by ", "
  
  # Ensure that the genes are valid column names
  valid_genes <- genes[genes %in% colnames(gene_matrix)]
  
  # Set the matrix values to 1 for valid genes associated with the current pathway
  gene_matrix[i, valid_genes] <- 1
}

# Step 4: Check the resulting gene matrix
print(gene_matrix)

# Step 5: Write the matrix to an Excel file
library(openxlsx)
write.xlsx(gene_matrix, file = ("C:/Users/cst325/Desktop/BACHELORS/Rdata/genematrix_up_cluster.xlsx"), rowNames = TRUE)
```


-------------------------------------------- GSEA - Enrichment plot --------------------------------------------


# Create named log2FC vector (ENTREZID is preferred for clusterProfiler)
# Create named gene list (log2FoldChange should be ranked)
gene_list <- up_cluster_filtered_annotated$log2FoldChange
names(gene_list) <- up_cluster_filtered_annotated$ENTREZID  # Map gene IDs to the fold change values
gene_list <- sort(gene_list, decreasing = TRUE)  # Sort by fold change, in decreasing order for GSEA

head(gene_list)
library(org.Hs.eg.db)
valid_ids <- keys(org.Hs.eg.db, keytype = "ENTREZID")
head(valid_ids)

gsea_go <- gseGO(
  geneList     = gene_list,
  OrgDb        = org.Hs.eg.db,
  keyType      = "ENTREZID",
  ont          = "ALL",  # or "ALL", "MF", "CC"
  nPerm        = 1000,
  minGSSize    = 10,
  maxGSSize    = 3000,
  pvalueCutoff = 0.05,
  verbose      = TRUE
)

head(gsea_go@result)

if (!requireNamespace("enrichplot", quietly = TRUE)) {
  install.packages("enrichplot")
}
library(enrichplot)

# List top enriched terms
head(gsea_go@result$Description)

# Create GSEA plot and store it in a variable
gsea_plot <- gseaplot2(gsea_go, 
                       geneSetID = 1:5, 
                       pvalue_table = TRUE, 
                       color = c("#FFA500", "#FF66CC", "#66B2FF"),
                       title = "GSEA results for upregulated in clusterivation")

# Save the plot as it is
ggsave("GSEA_plot.png", plot = gsea_plot, width = 10, height = 8, dpi = 300)

# After the plot is created, use gridExtra and grid to modify the plot
library(grid)
library(gridExtra)

# Create the plot without theme changes first
gsea_plot <- gseaplot2(gsea_go, 
                       geneSetID = 1:5, 
                       pvalue_table = TRUE, 
                       color = c("#FFA500", "#FF66CC", "#66B2FF"),
                       ES_geom = "dot", 
                       title = "GSEA results for upregulated in clusterivation")

# Adjust legend using `gridExtra`
gsea_plot_adjusted <- grid.arrange(gsea_plot, 
                                   top = textGrob("GSEA results for upregulated in clusterivation", gp = gpar(fontsize = 16, fontface = "bold")),
                                   bottom = textGrob("Legend", gp = gpar(fontsize = 10)))

# Save the adjusted plot
ggsave("GSEA_plot_adjusted.png", plot = gsea_plot_adjusted, width = 10, height = 8, dpi = 300)


## DOWNREGULATED
```{r}
# Sort table by baseMean in ascending order
down_cluster_sorted <- down_cluster[order(down_cluster$baseMean),]

#Calculate total number of rows (genes)
n <- nrow(down_cluster_sorted)

# Find median
median_pos <- ceiling(n / 2)

# Calculate Q1 position of the median
q1_of_median <- ceiling ((median_pos + 1)/4)

# Filter out low baseMean genes
down_cluster_filtered <- down_cluster_sorted[which(down_cluster_sorted$baseMean >= q1_of_median), ]

# Check how many genes are left
nrow(down_cluster_filtered)

# Optional: preview the filtered table
head(down_cluster_filtered)
```

```{r}
# Convert Ensembl IDs to Entrez IDs
gene.df <- bitr(down_cluster_filtered$GENEID, fromType = "ENSEMBL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)

# Merge with filtered table to retain original data
down_cluster_filtered_annotated <- merge(down_cluster_filtered, gene.df, by.x = "GENEID", by.y = "ENSEMBL")

# Check the first few rows after annotation
head(down_cluster_filtered_annotated)

```

-------------------------------------------- ENRICHMENT - GO --------------------------------------------
```{r}
# Perform GO enrichment analysis 
ego_down_cluster <- enrichGO(gene = down_cluster_filtered_annotated$ENTREZID,
                   OrgDb = org.Hs.eg.db,
                   keyType = "ENTREZID",
                   ont = "ALL",
                   pAdjustMethod = "BH",
                   pvalueCutoff = 0.05,
                   qvalueCutoff = 0.2,
                   readable = TRUE,
                   minGSSize = 10,
                   maxGSSize = 1000
)

tab_go_down_cluster <- as.data.frame(ego_down_cluster@result)

head(ego_down_cluster)
```
```{r}
# Write the pathway data to an Excel file
write.xlsx(tab_go_down_cluster, file = "C:/Users/cst325/Desktop/BACHELORS/Rdata/Data/cluster/DOWN/GO_down_cluster.xlsx", rowNames = TRUE)
```


## Visualization
```{r}
dotplot(ego_down_cluster, showCategory = 30)
barplot(ego_down_cluster, showCategory = 30)
```

## Dotplot
```{r}
plot_data <- ego_down_cluster@result

# Filter for significant p-values
plot_data <- plot_data[plot_data$p.adjust <= 0.05, ]
plot_data <- plot_data[order(plot_data$RichFactor, decreasing = TRUE), ]
plot_data <- head(plot_data, 30)

p <- ggplot(plot_data, aes(x = reorder(Description, RichFactor), y = RichFactor, 
                      size = Count, color = pvalue)) +
  geom_point() +
  coord_flip() +
  labs(x = "GO Terms", y = "RichFactor", title = "Downregulated GO Term Enrichment for clusterivation") +
  scale_size_continuous(name = "Gene Count") +
  scale_color_gradient(low = "blue", high = "red") +
  scale_shape_manual(values = c(16, 17, 18)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("C:/Users/cst325/Desktop/BACHELORS/Rdata/Plots/DOWNggGO_cluster_pathways.jpg", plot = p, width = 10, height = 8, dpi = 300)

```

-------------------------------------------- ENRICHMENT - KEGG --------------------------------------------
```{r}
ekegg_down_cluster <- enrichKEGG(
  gene          = down_cluster_filtered_annotated$ENTREZID,
  organism      = 'hsa',
  keyType       = "ncbi-geneid",
  pAdjustMethod = "BH",
  pvalueCutoff  = 0.05,
  minGSSize = 10,
  maxGSSize = 1000
)

tab_kegg_down_cluster <- as.data.frame(ekegg_down_cluster)

head(tab_kegg_down_cluster)
```

```{r}
library(org.Hs.eg.db)

tab_kegg_down_cluster$geneID_split <- strsplit(as.character(tab_kegg_down_cluster$geneID), "/")

map_entrez_to_symbol <- function(entrez_ids) {
  entrez_ids <- entrez_ids[entrez_ids != ""]
  gene_symbols <- mapIds(org.Hs.eg.db, keys = entrez_ids, column = "SYMBOL", keytype = "ENTREZID", multiVals = "first")
  return(gene_symbols)
}

tab_kegg_down_cluster$GENENAME <- lapply(tab_kegg_down_cluster$geneID_split, map_entrez_to_symbol)
tab_kegg_down_cluster$GENENAME <- lapply(tab_kegg_down_cluster$GENENAME, function(x) paste(x, collapse = "/"))

head(tab_kegg_down_cluster)

tab_kegg_down_cluster$geneID <- tab_kegg_down_cluster$GENENAME
tab_kegg_down_cluster$GENENAME <- NULL

head(tab_kegg_down_cluster)
```

```{r}
write.xlsx(tab_kegg_down_cluster, file = "C:/Users/cst325/Desktop/BACHELORS/Rdata/Data/cluster/DOWN/kegg_down_cluster.xlsx", rowNames = TRUE)
```

# Visualization
```{r}
dotplot(ekegg_down_cluster, showCategory = 30)
barplot(ekegg_down_cluster, showCategory = 30)
```

# Dotplot
```{r}
plot_data <- ekegg_down_cluster@result

# Filter for significant p-values
plot_data <- plot_data[plot_data$p.adjust <= 0.05, ]
plot_data <- plot_data[order(plot_data$RichFactor, decreasing = TRUE), ]
plot_data <- head(plot_data, 30)

p <- ggplot(plot_data, aes(x = reorder(Description, RichFactor), y = RichFactor, 
                           size = Count, color = pvalue)) +
  geom_point() +
  coord_flip() +
  labs(x = "KEGG Pathways", y = "RichFactor", title = "Downregulated KEGG Pathway Enrichment for clusterivation ") +
  scale_size_continuous(name = "Gene Count") +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("C:/Users/cst325/Desktop/BACHELORS/Rdata/Plots/DOWNKEGG_cluster_pathways.jpg", 
       plot = p, width = 10, height = 8, dpi = 300)
```

-------------------------------------------- ENRICHMENT - REAC --------------------------------------------

```{r}
ereact_down_cluster <- enrichPathway(
  gene = down_cluster_filtered_annotated$ENTREZID,
  organism = "human",
  pAdjustMethod = "BH",
  qvalueCutoff = 0.05,
  readable = TRUE,
  minGSSize = 10,
  maxGSSize = 1000
) 

tab_react_down_cluster <- as.data.frame(ereact_down_cluster@result)

head(ereact_down_cluster)

```
```{r}
write.xlsx(tab_react_down_cluster, file = "C:/Users/cst325/Desktop/BACHELORS/Rdata/Data/cluster/DOWN/react_down_cluster.xlsx", rowNames = TRUE)
```

```{r}
dotplot(ereact_down_cluster, showCategory = 30)
barplot(ereact_down_cluster, showCategory = 30)
```

```{r}
plot_data <- ereact_down_cluster@result

plot_data <- plot_data[plot_data$p.adjust <= 0.05, ]
plot_data <- plot_data[order(plot_data$RichFactor, decreasing = TRUE), ]
plot_data <- head(plot_data, 30)

p <- ggplot(plot_data, aes(x = reorder(Description, RichFactor), y = RichFactor, 
                           size = Count, color = pvalue)) +
  geom_point() +
  coord_flip() +
  labs(x = "REAC Pathways", y = "RichFactor", title = "Downregulated REAC Pathway Enrichment for clusterivation ") +
  scale_size_continuous(name = "Gene Count") +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("C:/Users/cst325/Desktop/BACHELORS/Rdata/Plots/DOWNREAC_cluster_filteredpathways.jpg", 
       plot = p, width = 10, height = 8, dpi = 300)
```

-------------------------------------------- ENRICHMENT - TF --------------------------------------------
```{r}
dorothea_hs <- dorothea::dorothea_hs

dorothea_tf <- dorothea_hs %>%
  dplyr::filter(confidence %in% c("A", "B")) %>%
  dplyr::select(tf, target) %>%
  dplyr::distinct()

etf_down_cluster <- enricher(
  gene = down_cluster_filtered_annotated$GENENAME,
  TERM2GENE = dorothea_tf,
  pAdjustMethod = "BH",
  qvalueCutoff = 0.05,
  minGSSize = 10,
  maxGSSize = 1000
) 

tab_tf_down_cluster <- as.data.frame(etf_down_cluster@result)

head(etf_down_cluster)
```

```{r}
write.xlsx(tab_tf_down_cluster, file = "C:/Users/cst325/Desktop/BACHELORS/Rdata/Data/cluster/DOWN/TF_down_cluster.xlsx", rowNames = TRUE)
```

# Visualization
```{r}
dotplot(etf_down_cluster, showCategory = 30)
barplot(etf_down_cluster, showCategory = 30)
```

# Dotplot
```{r}
plot_data <- etf_down_cluster@result

plot_data <- plot_data[plot_data$p.adjust <= 0.05, ]
plot_data <- plot_data[order(plot_data$RichFactor, decreasing = TRUE), ]
plot_data <- head(plot_data, 30)

p <- ggplot(plot_data, aes(x = reorder(Description, RichFactor), y = RichFactor, 
                           size = Count, color = pvalue)) +
  geom_point() +
  coord_flip() +
  labs(x = "TF Pathways", y = "RichFactor", title = "Downregulated TF for clusterivation ") +
  scale_size_continuous(name = "Gene Count") +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("C:/Users/cst325/Desktop/BACHELORS/Rdata/Plots/DOWNTF_cluster_filteredpathways.jpg",
       plot = p, width = 10, height = 8, dpi = 300)
```

-------------------------------------------- ENRICHMENT - MSigDB --------------------------------------------
```{r}
hallmark_gmt <- read.gmt("C:/Users/cst325/Desktop/BACHELORS/Rdata/Databases/h.all.v2024.1.Hs.symbols.gmt")

c8_gmt <- read.gmt("C:/Users/cst325/Desktop/BACHELORS/Rdata/Databases/c8.all.v2024.1.Hs.symbols.gmt")

# Hallmark ORA
edownhallmark_cluster <- enricher(
  gene = down_cluster_filtered_annotated$GENENAME,
  TERM2GENE = hallmark_gmt,
  pAdjustMethod = "BH",
  qvalueCutoff = 0.05,
  minGSSize = 10,
  maxGSSize = 1000
)

tab_hallmarks_down_cluster <- as.data.frame(edownhallmark_cluster@result)

head (edownhallmark_cluster)
```

```{r}
write.xlsx(tab_hallmarks_down_cluster, file = "C:/Users/cst325/Desktop/BACHELORS/Rdata/Data/cluster/DOWN/HALLMARKS_down_cluster.xlsx", rowNames = TRUE)
```


# Visualization
```{r}
dotplot(edownhallmark_cluster, showCategory = 30)

barplot(edownhallmark_cluster, showCategory = 30)
```

#Dotplot
```{r}
plot_data <- edownhallmark_cluster@result

plot_data <- plot_data[plot_data$p.adjust <= 0.05, ]
plot_data <- plot_data[order(plot_data$RichFactor, decreasing = TRUE), ]
plot_data <- head(plot_data, 30)

p <- ggplot(plot_data, aes(x = reorder(Description, RichFactor), y = RichFactor, 
                           size = Count, color = pvalue)) +
  geom_point() +
  coord_flip() +
  labs(x = "Hallmarks", y = "RichFactor", title = "Downregulated Hallmarks for clusterivation ") +
  scale_size_continuous(name = "Gene Count") +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("C:/Users/cst325/Desktop/BACHELORS/Rdata/Plots/DOWNHallmarks_cluster_filteredpathways.jpg", 
       plot = p, width = 10, height = 8, dpi = 300)
```

-------------------------------------------- ORA results --------------------------------------------
```{r}
tab_kegg_down_cluster$geneID       <- as.character(tab_kegg_down_cluster$geneID)

tab_go_down_cluster$Source <- "GO"
tab_kegg_down_cluster$Source <- "KEGG"
tab_react_down_cluster$Source <- "reactome"
tab_tf_down_cluster$Source <- "TF"
tab_hallmarks_down_cluster$Source <- "MSigDB"

pval_cutoff <- 0.05
RichFactor_min <- 0.1

down_cluster_enrich <- bind_rows(
  tab_go_down_cluster,
  tab_kegg_down_cluster,
  tab_react_down_cluster,
  tab_tf_down_cluster,
  tab_hallmarks_down_cluster,
)

down_cluster_enrich_filtered <- down_cluster_enrich %>%
  dplyr::filter(
    p.adjust <= pval_cutoff,
    RichFactor >= RichFactor_min,
    Count >= 3
  ) %>%
  mutate(
    importance = -log10(p.adjust) * RichFactor
  ) %>%
  arrange(desc(importance))

top_pathways <- down_cluster_enrich_filtered %>% head(20)

library(writexl)
write_xlsx(down_cluster_enrich_filtered, "C:/Users/cst325/Desktop/BACHELORS/Rdata/Data/down_cluster_enrich_filtered.xlsx")

convert_to_factors <- function(df) {
  for (col in colnames(df)) {
    if (is.character(df[[col]])) {
      df[[col]] <- as.factor(df[[col]])
    }
  }
  return(df)
}

fact.down_cluster_enrich_filtered <- convert_to_factors(down_cluster_enrich_filtered)

head(down_cluster_enrich_filtered)

summary(fact.down_cluster_enrich_filtered)
```

## Pathway to gene table
```{r}
df <- down_cluster_enrich_filtered

gene_list <- strsplit(df$geneID, split = "/")

max_genes <- max(sapply(gene_list, length))

gene_matrix <- t(sapply(gene_list, function(x) {
  length(x) <- max_genes
  return(x)
}))

gene_df <- as.data.frame(gene_matrix, stringsAsfactors = FALSE)
colnames(gene_df) <- paste0("Gene_", seq_len(max_genes))

pathway_down_cluster <- cbind(Pathway_ID = df$ID, gene_df)
# Set ID as rownames
rownames(pathway_down_cluster) <- df$ID

# Add Description as a column
pathway_down_cluster$Pathway_ID <- df$Description

# Rename the 'Pathway_ID' column to 'Description'
colnames(pathway_down_cluster)[colnames(pathway_down_cluster) == "Pathway_ID"] <- "Description"

# Check the result
head(pathway_down_cluster)

library(openxlsx)

write.xlsx(pathway_down_cluster, file = "C:/Users/cst325/Desktop/BACHELORS/Rdata/pathwaytogene_down_cluster.xlsx", rowNames = TRUE)
```

# Gene Matrix

```{r}
pathway_gene_symbols <- data.frame(
  Pathway = character(0),
  GeneSymbols = character(0),
  stringsAsFactors = FALSE
)

for (i in 1:nrow(down_cluster_enrich_filtered)) {
  pathway_description <- down_cluster_enrich_filtered$Description[i]

  gene_symbols <- unlist(strsplit(down_cluster_enrich_filtered$geneID[i], "/"))
  gene_symbols <- gene_symbols[!is.na(gene_symbols) & gene_symbols != ""]
  gene_symbols_str <- paste(gene_symbols, collapse = ", ")

  pathway_gene_symbols <- rbind(pathway_gene_symbols, data.frame(Pathway = pathway_description, GeneSymbols = gene_symbols_str, stringsAsfactors = FALSE))
}

print(pathway_gene_symbols)

unique_genes <- unique(unlist(strsplit(paste(pathway_gene_symbols$GeneSymbols, collapse = ","), ", ")))

gene_matrix <- matrix(0, nrow = length(pathway_gene_symbols$Pathway), ncol = length(unique_genes))

rownames(gene_matrix) <- pathway_gene_symbols$Pathway
colnames(gene_matrix) <- unique_genes

for (i in 1:nrow(gene_matrix)) {
  genes <- unlist(strsplit(pathway_gene_symbols$GeneSymbols[i], ", "))
  valid_genes <- genes[genes %in% colnames(gene_matrix)]
  gene_matrix[i, valid_genes] <- 1
}

print(gene_matrix)

library(openxlsx)
write.xlsx(gene_matrix, file = ("C:/Users/cst325/Desktop/BACHELORS/Rdata/genematrix_down_cluster.xlsx"), rowNames = TRUE)
```

## MIXED

```{r}
# Add direction labels
down_cluster_enrich_filtered$Direction <- "Down"
up_cluster_enrich_filtered$Direction <- "Up"

# Combine datasets
combined_enrich_cluster <- rbind(down_cluster_enrich_filtered, up_cluster_enrich_filtered)

```


### Mixed dotplot
```{r}
# Convert GeneRatio if it's a fraction string
combined_enrich_cluster$GeneRatio <- sapply(combined_enrich_cluster$GeneRatio, function(x) {
  eval(parse(text = x))
})
```
```{r}
# Select top 30 by p.adjust for each direction
top_enrich <- combined_enrich_cluster %>%
  group_by(Direction) %>%
  arrange(p.adjust) %>%
  slice_head(n = 30) %>%
  ungroup()

# Up Pathways Plot
up_plot <- ggplot(top_enrich %>% dplyr::filter(Direction == "Up"), aes(x = GeneRatio, y = fct_reorder(Description, GeneRatio))) +
  geom_segment(aes(xend = 0, yend = Description), color = "grey") +
  geom_point(aes(color = p.adjust, size = Count)) +
  scale_color_gradientn(
    colours = c("#f7ca64", "#46bac2", "#7e62a3"),
    trans = "log10",
    guide = guide_colorbar(reverse = TRUE, order = 1)
  ) +
  scale_size_continuous(range = c(2, 10)) +
  labs(
    x = "Gene Ratio",
    y = "Enriched Term",
    color = "Adjusted p-value",
    size = "Gene Count",
    title = "Dot Plot of Upregulated in clusterivation Enrichment Analysis"
  ) +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10),
    plot.title = element_text(hjust = 0.5),
    legend.position = "right"
  )


# Down Pathways Plot
down_plot <- ggplot(top_enrich %>% dplyr::filter(Direction == "Down"), aes(x = GeneRatio, y = fct_reorder(Description, GeneRatio))) +
  geom_segment(aes(xend = 0, yend = Description), color = "grey") +
  geom_point(aes(color = p.adjust, size = Count)) +
  scale_color_gradientn(
    colours = c("#f7ca64", "#46bac2", "#7e62a3"),
    trans = "log10",
    guide = guide_colorbar(reverse = TRUE, order = 1)
  ) +
  scale_size_continuous(range = c(2, 10)) +
  labs(
    x = "Gene Ratio",
    y = "Enriched Term",
    color = "Adjusted p-value",
    size = "Gene Count",
    title = "Dot Plot of Downregulated in clusterivation Enrichment Analysis"
  ) +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10),
    plot.title = element_text(hjust = 0.5),
    legend.position = "right"
  )

# Save the plots separately
ggsave("C:/Users/cst325/Desktop/BACHELORS/Rdata/Plots/Up_cluster_enrichment.jpg", 
       plot = up_plot, width = 12, height = 8, dpi = 300)

ggsave("C:/Users/cst325/Desktop/BACHELORS/Rdata/Plots/Down_cluster_enrichment.jpg", 
       plot = down_plot, width = 12, height = 8, dpi = 300)

```

```{r}
library(ggplot2)
library(dplyr)
library(forcats)

# Plot
p <- ggplot(top_enrich, aes(x = GeneRatio, y = fct_reorder(Description, GeneRatio))) +
  geom_segment(aes(xend = 0, yend = Description), color = "grey") +
  geom_point(aes(color = p.adjust, size = Count)) +
  scale_color_gradientn(
    colours = c("#f7ca64", "#46bac2", "#7e62a3"),
    trans = "log10",
    guide = guide_colorbar(reverse = TRUE, order = 1)
  ) +
  scale_size_continuous(range = c(2, 10)) +
  labs(
    x = "Gene Ratio",
    y = "Enriched Term",
    color = "Adjusted p-value",
    size = "Gene Count",
    title = "Dot Plot of clusterivation Enrichment Analysis"
  ) +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10),
    plot.title = element_text(hjust = 0.5),
    legend.position = "right"
  )

# Save the plot
ggsave("C:/Users/cst325/Desktop/BACHELORS/Rdata/Plots/cluster_enrichment_clusterProfiler_style.jpg",
       plot = p, width = 10, height = 8, dpi = 300)

```

### CordDiagram

# With MSigDB

```{r}
# Step 1: Get top 5 upregulated and top 5 downregulated pathways
top_paths_up <- up_cluster_enrich_filtered %>%
  arrange(p.adjust) %>%
  slice_head(n = 5)

top_paths_down <- down_cluster_enrich_filtered %>%
  arrange(p.adjust) %>%
  slice_head(n = 5)

top_paths <- bind_rows(top_paths_up, top_paths_down)

# Step 2: Create pathway-gene mapping
pathway_gene_symbols <- data.frame(
  Pathway = character(0),
  GeneSymbols = character(0),
  stringsAsFactors = FALSE
)

for (i in 1:nrow(top_paths)) {
  pathway_description <- top_paths$Description[i]
  
  # Use gene symbols directly from geneID
  gene_symbols <- unlist(strsplit(top_paths$geneID[i], "/"))
  gene_symbols <- gene_symbols[!is.na(gene_symbols) & gene_symbols != ""]
  
  gene_symbols_str <- paste(gene_symbols, collapse = ", ")
  
  pathway_gene_symbols <- rbind(pathway_gene_symbols, data.frame(
    Pathway = pathway_description,
    GeneSymbols = gene_symbols_str,
    stringsAsfactors = FALSE
  ))
}

# Step 3: Generate unique gene symbol vector
unique_genes <- unique(unlist(strsplit(paste(pathway_gene_symbols$GeneSymbols, collapse = ","), ", ")))

# Step 4: Create gene matrix (pathways x gene symbols)
gene_matrix <- matrix(0, nrow = length(pathway_gene_symbols$Pathway), ncol = length(unique_genes))
rownames(gene_matrix) <- pathway_gene_symbols$Pathway
colnames(gene_matrix) <- unique_genes

# Step 5: Fill matrix with 1s where a gene is associated with a pathway
for (i in 1:nrow(gene_matrix)) {
  genes <- unlist(strsplit(pathway_gene_symbols$GeneSymbols[i], ", "))
  valid_genes <- genes[genes %in% colnames(gene_matrix)]
  gene_matrix[i, valid_genes] <- 1
}
```

```{r}
gene_log2FC_df <- bind_rows(up_cluster_filtered_annotated, down_cluster_filtered_annotated)
gene_log2FC <- gene_log2FC_df$log2FoldChange
names(gene_log2FC) <- gene_log2FC_df$GENENAME
```

```{r}
library(circlize)
library(ComplexHeatmap)
library(grid)

# Define the color function
# Color function: blue (down), white (neutral), red (up)
lfc_range <- range(gene_log2FC, na.rm = TRUE)
col_fun <- colorRamp2(
  breaks = c(min(-10), 0, max(10)),
  colors = c("blue", "white", "red")
)

# Assign colors to genes based on log2FC
gene_colors <- setNames(col_fun(gene_log2FC), names(gene_log2FC))

# Step 1: Chord Diagram Plot
# Adjust circos settings
circos.par(gap.degree = 1, # Slightly increase gap between sectors
           start.degree = 90, # Position the first sector at the top
           cell.padding = c(0, 0, 0, 0))  # Tighten the padding around cells

# 1. Saturated candy color palette for pathways
pathway_names <- rownames(gene_matrix)
pathway_colors <- setNames(rep(c(
  "#FF4C65",  # vibrant pink-red
  "#00BFC4",  # teal cyan
  "#FFA500",  # orange
  "#7CAE00",  # lime green
  "#C77CFF",  # lavender purple
  "#00BA38",  # vibrant green
  "#619CFF",  # blue
  "#36013F",  # deep purple
  "#FF61C3",  # pink
  "#8491B4"   # steel blue
), length.out = length(pathway_names)), pathway_names)

# 2. Merge all grid colors
grid_colors <- c(gene_colors, pathway_colors)

# 3. Draw chord diagram and save it to PNG
png("C:/Users/cst325/Desktop/chord_diagram_plot.png", width = 800, height = 800)
chordDiagram(
  gene_matrix,
  annotationTrack = "grid",
  preAllocateTracks = list(track.height = 0.05),
  grid.col = grid_colors,
  transparency = 0.4,
  directional = 1,
  direction.type = "arrows",
  link.arr.type = "big.arrow",
)

# 5. Add labels only to genes with clockwise positioning (smaller labels)
circos.trackPlotRegion(track.index = 2, panel.fun = function(x, y) {
  sector.name <- get.cell.meta.data("sector.index")
  if (sector.name %in% names(gene_log2FC)) {
    xlim <- get.cell.meta.data("xlim")
    ylim <- get.cell.meta.data("ylim")
    # Print labels clockwise with smaller text
    circos.text(mean(xlim), ylim[1] + 2.5, sector.name, 
                facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5), cex = 0.8)  # Reduced cex for smaller labels
  }
}, bg.border = NA)
dev.off()

# Step 2: Pathway Legend (smaller and placed top-right)
pathway_legend <- Legend(
  labels = names(pathway_colors), 
  legend_gp = gpar(fill = pathway_colors),
  title = "Pathways",
  title_gp = gpar(fontface = "bold"),
  labels_gp = gpar(fontsize = 10),
  ncol = 1,  # Stack vertically
  gap = unit(4, "pt"),
  grid_height = unit(8, "mm"),
  grid_width = unit(8, "mm")
)

# Save as image (increased width and height to avoid clipping)
png("pathway_legend.png", width = 1000, height = 800, res = 120)
grid.newpage()
draw(pathway_legend, x = unit(0.1, "npc"), y = unit(0.9, "npc"), just = c("left", "top"))
dev.off()

# Create the updated Log2FC legend
log2fc_legend <- Legend(
  col_fun = col_fun,
  title = "log2 Fold Change",
  title_gp = gpar(fontface = "bold"),
  labels_gp = gpar(fontsize = 10),
  direction = "horizontal",
  legend_width = unit(5, "cm")
)

# Save Log2FC legend to file
png("log2fc_legend.png", width = 500, height = 150, res = 120)
grid.newpage()
draw(log2fc_legend, x = unit(0.5, "npc"), y = unit(0.5, "npc"), just = "center")
dev.off()
```

### Enrichment map

```{r}
# Load necessary libraries
library(DOSE)
library(enrichplot)
library(cowplot)

# Prepare the data for each enrichment result (KEGG, GO, reactOME, Dorothea)
# Assuming you already have enrichment results for these (replace 'ekegg_up_cluster', etc.)

# KEGG Enrichment
ekegg_up_cluster@result$regulation <- "up"
ekegg_down_cluster@result$regulation <- "down"
ekegg_cluster_combined <- ekegg_up_cluster
ekegg_cluster_combined@result <- rbind(ekegg_up_cluster@result, ekegg_down_cluster@result)
ekegg_cluster_combined@result <- ekegg_cluster_combined@result[ekegg_cluster_combined@result$p.adjust < 0.05, ]
ekegg_cluster_combined@result <- ekegg_cluster_combined@result[order(ekegg_cluster_combined@result$GeneRatio, decreasing = TRUE), ]
ekegg_term_sim_matrix <- pairwise_termsim(ekegg_cluster_combined)

# GO Enrichment 
ego_up_cluster@result$regulation <- "up"
ego_down_cluster@result$regulation <- "down"
ego_cluster_combined <- ego_up_cluster
ego_cluster_combined@result <- rbind(ego_up_cluster@result, ego_down_cluster@result)
ego_cluster_combined@result <- ego_cluster_combined@result[ego_cluster_combined@result$p.adjust < 0.05, ]
ego_cluster_combined@result <- ego_cluster_combined@result[order(ego_cluster_combined@result$GeneRatio, decreasing = TRUE), ]
ego_term_sim_matrix <- pairwise_termsim(ego_cluster_combined)

# reactOME Enrichment 
ereact_up_cluster@result$regulation <- "up"
ereact_down_cluster@result$regulation <- "down"
ereact_cluster_combined <- ereact_up_cluster
ereact_cluster_combined@result <- rbind(ereact_up_cluster@result, ereact_down_cluster@result)
ereact_cluster_combined@result <- ereact_cluster_combined@result[ereact_cluster_combined@result$p.adjust < 0.05, ]
ereact_cluster_combined@result <- ereact_cluster_combined@result[order(ereact_cluster_combined@result$GeneRatio, decreasing = TRUE), ]
ereact_term_sim_matrix <- pairwise_termsim(ereact_cluster_combined)

# Create EnrichMap plots for each enrichment type
set.seed(123)

# KEGG EnrichMap
emap_kegg <- emapplot(ekegg_term_sim_matrix, layout = "kk", 
                      group = TRUE, node_label = "category", 
                      nCluster = 3, , color = "regulation") + 
  scale_color_manual(values = c("up" = "red", "down" = "blue", "not_detected" = "grey"))

set.seed(123)

# GO EnrichMap
emap_go <- emapplot(ego_term_sim_matrix, layout = "kk", 
                    group = TRUE, node_label = "category", 
                    nCluster = 3, color = "regulation") + 
  scale_color_manual(values = c("up" = "red", "down" = "blue", "not_detected" = "grey"))

set.seed(123)

# reactOME EnrichMap
emap_reactome <- emapplot(ereact_term_sim_matrix, layout = "kk", 
                          group = TRUE, node_label = "category", 
                           nCluster = 4, color = "regulation") + 
  scale_color_manual(values = c("up" = "red", "down" = "blue", "not_detected" = "grey"))

# Combine the plots using cowplot
combined_plot <- plot_grid(emap_kegg, emap_go, emap_reactome, 
                           labels = c("A", "B", "C"), 
                           ncol = 1, 
                           align = "v") 

# Save the grid of the three plots
ggsave("emapplot_cluster.jpg", plot = cowplot::plot_grid(emap_kegg, emap_go, emap_reactome, ncol=3, labels=LETTERS[1:3]), 
       width = 28, height =10, dpi = 300)  # Adjust the dimensions as needed for the output size.
```

### Cnetplot
```{r}
library(enrichplot)
library(clusterProfiler)
library(org.Hs.eg.db)  # Make sure this is loaded for human gene annotations
library(cowplot)
library(ggplot2)

# Create the geneList using log2 fold changes
geneList <- res_gene_cluster_annotated$log2FoldChange

# Set the gene identifiers as names of the vector (usually rownames(res))
names(geneList) <- rownames(res_gene_cluster_annotated)

ekegg_up_cluster <- setReadable(ekegg_up_cluster, 'org.Hs.eg.db', 'ENTREZID')

p1 <- cnetplot(ekegg_up_cluster,
              igraph::layout_nicely,
              color_edge = 'category',
              showCategory = 4,
              foldChange = geneList)

p2 <- cnetplot(ekegg_up_cluster,
              igraph::layout_in_circle,
              color_edge = 'category',
              showCategory = 4,
              foldChange = geneList)

# Save the grid of the three plots
ggsave("cnetplot_cluster_kegg.jpg", plot = cowplot::plot_grid(p1, p2, ncol=2, labels=LETTERS[1:2], rel_widths=c(0.9,1.1)), 
       width = 20, height =10, dpi = 300)  # Adjust the dimensions as needed for the output size.
```

